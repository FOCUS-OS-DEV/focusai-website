---
import '../styles/global.css';
import CookieConsent from '../components/CookieConsent.astro';
import Analytics from '../components/Analytics.astro';
import AnalyticsBody from '../components/AnalyticsBody.astro';
import BackToTop from '../components/BackToTop.astro';
import WhatsAppFloat from '../components/WhatsAppFloat.astro';
import Preloader from '../components/Preloader.astro';
import { siteConfig } from '../data/config';

interface Props {
  title: string;
  description?: string;
  image?: string;
  structuredData?: object | object[];
}

const {
  title,
  description = "Focus AI - מגשרים על הפער בין אנשים לטכנולוגיה. הכשרות מקצועיות ונציגי AI לעסקים.",
  image = "https://res.cloudinary.com/dfudxxzlj/image/upload/q_auto,f_auto,w_1200/v1765302030/focusai-og-image.png",
  structuredData
} = Astro.props;

const canonicalURL = Astro.site ? new URL(Astro.url.pathname, Astro.site) : Astro.url;

// Organization Schema - present on all pages
const organizationSchema = {
  "@context": "https://schema.org",
  "@type": "Organization",
  "name": "Focus AI",
  "alternateName": "פוקוס AI",
  "url": "https://focusai.co.il",
  "logo": siteConfig.assets.logo,
  "description": "מגשרים על הפער בין אנשים לטכנולוגיה. הכשרות מקצועיות ופתרונות AI לעסקים.",
  "email": siteConfig.contact.email,
  "telephone": siteConfig.contact.phone,
  "address": {
    "@type": "PostalAddress",
    "addressLocality": "הרצליה",
    "addressCountry": "IL"
  },
  "sameAs": [
    siteConfig.social.instagram,
    siteConfig.social.facebook,
    siteConfig.social.tiktok
  ],
  "contactPoint": {
    "@type": "ContactPoint",
    "telephone": siteConfig.contact.phone,
    "contactType": "customer service",
    "availableLanguage": ["Hebrew", "English"]
  }
};

// WebSite Schema for search box
const websiteSchema = {
  "@context": "https://schema.org",
  "@type": "WebSite",
  "name": "Focus AI",
  "url": "https://focusai.co.il",
  "inLanguage": "he-IL",
  "publisher": {
    "@type": "Organization",
    "name": "Focus AI"
  }
};
---

<!DOCTYPE html>
<html lang="he" dir="rtl" class="lenis lenis-smooth preloader-active">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#0a0a0f" />

  <!-- SEO -->
  <title>{title}</title>
  <meta name="description" content={description} />
  <link rel="canonical" href={canonicalURL} />

  <!-- Open Graph / Facebook -->
  <meta property="og:type" content="website" />
  <meta property="og:url" content={canonicalURL} />
  <meta property="og:title" content={title} />
  <meta property="og:description" content={description} />
  <meta property="og:image" content={image} />
  <meta property="og:locale" content="he_IL" />

  <!-- Twitter -->
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content={title} />
  <meta name="twitter:description" content={description} />
  <meta name="twitter:image" content={image} />

  <!-- Favicon -->
  <link rel="icon" type="image/png" href="/favicon.png" />
  <link rel="icon" href="/favicon.png" />
  <link rel="apple-touch-icon" href="/favicon.png" />

  <!-- Fonts - Cyberpunk Theme (Optimized Loading) -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <!-- Critical font: Rubik (body text) - loaded immediately -->
  <link rel="preload" as="style" href="https://fonts.googleapis.com/css2?family=Rubik:wght@400;500;600;700;800;900&display=swap">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Rubik:wght@400;500;600;700;800;900&display=swap">
  <!-- Removed JetBrains Mono + Orbitron - site uses Rubik only -->

  <!-- Cloudinary CDN - Preconnect for faster asset loading -->
  <link rel="preconnect" href="https://res.cloudinary.com" crossorigin>
  <link rel="dns-prefetch" href="https://res.cloudinary.com">

  <!-- Preload LCP image (preloader logo) -->
  <link rel="preload" as="image" href="https://res.cloudinary.com/dfudxxzlj/image/upload/q_auto,f_auto,w_200/v1765571815/FOCUS_LOGO-06_2_grkja9.png" fetchpriority="high">

  <!-- Generator -->
  <meta name="generator" content={Astro.generator} />

  <!-- Structured Data (JSON-LD) -->
  <script type="application/ld+json" set:html={JSON.stringify(organizationSchema)} />
  <script type="application/ld+json" set:html={JSON.stringify(websiteSchema)} />
  {structuredData && Array.isArray(structuredData) ? (
    structuredData.map((schema) => (
      <script type="application/ld+json" set:html={JSON.stringify(schema)} />
    ))
  ) : structuredData && (
    <script type="application/ld+json" set:html={JSON.stringify(structuredData)} />
  )}

  <!-- Analytics (GTM, Clarity) - Respects Cookie Consent -->
  <Analytics />

  <!-- Page-specific head content -->
  <slot name="head" />
</head>
<body class="bg-[#0a0a0f] text-[#f5f5fa] font-sans antialiased preloader-active">
  <!-- Brand fingerprint watermark - fixed background, real element for stable positioning -->
  <div class="fingerprint-fixed" aria-hidden="true"></div>

  <!-- Skip to content (a11y) -->
  <a href="#main-content" class="sr-only focus:not-sr-only focus:fixed focus:top-4 focus:right-4 focus:z-[9999] focus:bg-[#a855f7] focus:text-white focus:px-4 focus:py-2 focus:rounded-lg focus:text-sm focus:font-bold">דלג לתוכן</a>

  <!-- Preloader (first child - renders before everything) -->
  <Preloader />

  <!-- GTM noscript fallback -->
  <AnalyticsBody />

  <slot name="header" />

  <main id="main-content">
    <slot />
  </main>

  <slot name="footer" />

  <!-- Cookie Consent Banner -->
  <CookieConsent />

  <!-- Floating UI -->
  <BackToTop />
  <WhatsAppFloat />

  <!-- Lenis Smooth Scroll + GSAP Scroll Animations (deferred for performance) -->
  <script>
    const isMobile = window.innerWidth < 768;

    async function initSmoothScrollAndAnimations() {
      const [{ default: Lenis }, { gsap }, { ScrollTrigger }, { initScrollAnimations }] = await Promise.all([
        import('lenis'),
        import('gsap'),
        import('gsap/ScrollTrigger'),
        import('../scripts/scroll-animations'),
      ]);

      gsap.registerPlugin(ScrollTrigger);

      // Initialize Lenis smooth scrolling - faster on mobile
      const lenis = new Lenis({
        duration: isMobile ? 0.6 : 1.0,
        easing: (t: number) => Math.min(1, 1.001 - Math.pow(2, -10 * t)),
        orientation: 'vertical',
        gestureOrientation: 'vertical',
        smoothWheel: true,
        wheelMultiplier: 1,
        touchMultiplier: 2,
      });

      // Connect Lenis to GSAP ScrollTrigger
      lenis.on('scroll', ScrollTrigger.update);

      gsap.ticker.add((time: number) => {
        lenis.raf(time * 1000);
      });

      gsap.ticker.lagSmoothing(0);

      // Make lenis available globally for other scripts
      (window as any).lenis = lenis;

      // Initialize scroll animations
      initScrollAnimations();
    }

    function startInit() {
      if (isMobile && 'requestIdleCallback' in window) {
        requestIdleCallback(() => initSmoothScrollAndAnimations(), { timeout: 200 });
      } else {
        initSmoothScrollAndAnimations();
      }
    }

    // Wait for preloader to finish before initializing Lenis/GSAP
    const preloaderEl = document.getElementById('preloader');
    if (preloaderEl && !preloaderEl.classList.contains('preloader-done')) {
      window.addEventListener('preloaderDone', startInit, { once: true });
    } else {
      startInit();
    }
  </script>

  <!-- Global form validation -->
  <script is:inline>
    document.addEventListener('DOMContentLoaded', function() {
      // Israeli phone regex: starts with 0, 9-10 digits, allows dashes
      var phoneRegex = /^0[2-9]\d?-?\d{3}-?\d{4}$/;
      var emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;

      document.querySelectorAll('form').forEach(function(form) {
        form.addEventListener('submit', function(e) {
          var phoneInput = form.querySelector('input[name="phone"], input[inputmode="tel"], input[type="tel"]');
          var emailInput = form.querySelector('input[name="email"], input[type="email"], input[inputmode="email"]');

          if (phoneInput && phoneInput.value) {
            var cleanPhone = phoneInput.value.replace(/[\s\-()]/g, '');
            if (!phoneRegex.test(cleanPhone) && cleanPhone.length < 9) {
              e.preventDefault();
              phoneInput.style.borderColor = '#ef4444';
              phoneInput.setCustomValidity('נא להזין מספר טלפון ישראלי תקין');
              phoneInput.reportValidity();
              return;
            }
            phoneInput.style.borderColor = '';
            phoneInput.setCustomValidity('');
          }

          if (emailInput && emailInput.value && !emailRegex.test(emailInput.value)) {
            e.preventDefault();
            emailInput.style.borderColor = '#ef4444';
            emailInput.setCustomValidity('נא להזין כתובת אימייל תקינה');
            emailInput.reportValidity();
            return;
          }
          if (emailInput) {
            emailInput.style.borderColor = '';
            emailInput.setCustomValidity('');
          }
        });
      });
    });
  </script>

  <!-- Scripts slot for page-specific scripts -->
  <slot name="scripts" />
</body>
</html>
