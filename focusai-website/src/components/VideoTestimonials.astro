---
/**
 * Video Testimonials - 3D Transform Carousel + Lightbox
 * Center card large, sides smaller, infinite loop, arrow nav
 * Click center → opens lightbox with native video controls
 * iOS safe: poster images in carousel, direct video src in lightbox HTML
 */

interface Props {
  title?: string;
  subtitle?: string;
  badge?: string;
  theme?: 'dark' | 'light';
}

const {
  title = "מספרים עלינו",
  subtitle = "בואו תשמעו מה יש לבוגרי ההכשרות שלנו לספר על החוויה שלהם",
  badge = "VIDEO_TESTIMONIALS",
  theme = "dark",
} = Astro.props;

const isLight = theme === 'light';
// When using default title, highlight "מספרים" with gradient
const useDefaultHighlight = !('title' in Astro.props);

const testimonials = [
  {
    name: "זוהר יעקב",
    role: "סטודנט הכשרת Focus AI",
    video: "https://res.cloudinary.com/dfudxxzlj/video/upload/q_auto/v1770301916/%D7%A4%D7%95%D7%A7%D7%95%D7%A1_%D7%96%D7%95%D7%94%D7%A8_%D7%99%D7%A2%D7%A7%D7%91_s4jds5.mp4",
    poster: "https://res.cloudinary.com/dfudxxzlj/video/upload/so_5,w_400,h_710,c_fill,q_auto,f_jpg/v1770301916/%D7%A4%D7%95%D7%A7%D7%95%D7%A1_%D7%96%D7%95%D7%94%D7%A8_%D7%99%D7%A2%D7%A7%D7%91_s4jds5.jpg",
  },
  {
    name: "חגית",
    role: "מנהלת המרכז לפיתוח קריירה, אוניברסיטת חיפה",
    video: "https://res.cloudinary.com/dfudxxzlj/video/upload/q_auto/v1770711629/IMG_0753_iah7ft_1_roxnqc.mp4",
    poster: "https://res.cloudinary.com/dfudxxzlj/video/upload/so_5,w_400,h_710,c_fill,q_auto,f_jpg/v1770711629/IMG_0753_iah7ft_1_roxnqc.jpg",
  },
  {
    name: "מטר",
    role: "בוגרת הכשרת Focus AI",
    video: "https://res.cloudinary.com/dfudxxzlj/video/upload/q_auto/v1770711703/%D7%9E%D7%98%D7%A8_%D7%A4%D7%95%D7%A7%D7%95%D7%A1_AI_jg7esj_qtan3r.mp4",
    poster: "https://res.cloudinary.com/dfudxxzlj/video/upload/so_5,w_400,h_710,c_fill,q_auto,f_jpg/v1770711703/%D7%9E%D7%98%D7%A8_%D7%A4%D7%95%D7%A7%D7%95%D7%A1_AI_jg7esj_qtan3r.jpg",
  },
  {
    name: "בני",
    role: "בוגר הכשרת Focus AI",
    video: "https://res.cloudinary.com/dfudxxzlj/video/upload/q_auto/v1770711663/IMG_3467_pg6tos_1_pkb8qv.mp4",
    poster: "https://res.cloudinary.com/dfudxxzlj/video/upload/so_5,w_400,h_710,c_fill,q_auto,f_jpg/v1770711663/IMG_3467_pg6tos_1_pkb8qv.jpg",
  },
  {
    name: "שניר",
    role: "בוגר הכשרת Focus AI",
    video: "https://res.cloudinary.com/dfudxxzlj/video/upload/q_auto/v1770711683/%D7%A9%D7%A0%D7%99%D7%A8_%D7%A4%D7%95%D7%A7%D7%95%D7%A1_AI_mxbzrj_1_cwq90t.mp4",
    poster: "https://res.cloudinary.com/dfudxxzlj/video/upload/so_5,w_400,h_710,c_fill,q_auto,f_jpg/v1770711683/%D7%A9%D7%A0%D7%99%D7%A8_%D7%A4%D7%95%D7%A7%D7%95%D7%A1_AI_mxbzrj_1_cwq90t.jpg",
  },
  {
    name: "ארטיום",
    role: "בוגר הכשרת Focus AI",
    video: "https://res.cloudinary.com/dfudxxzlj/video/upload/q_auto/v1770711686/%D7%90%D7%A8%D7%98%D7%99%D7%95%D7%9D_%D7%A4%D7%95%D7%A7%D7%95%D7%A1_AI_pzkt2y_1_zaaisz.mp4",
    poster: "https://res.cloudinary.com/dfudxxzlj/video/upload/so_5,w_400,h_710,c_fill,q_auto,f_jpg/v1770711686/%D7%90%D7%A8%D7%98%D7%99%D7%95%D7%9D_%D7%A4%D7%95%D7%A7%D7%95%D7%A1_AI_pzkt2y_1_zaaisz.jpg",
  },
  {
    name: "אופיר וינקלר",
    role: "סטודנט הכשרת Focus AI",
    video: "https://res.cloudinary.com/dfudxxzlj/video/upload/q_auto/v1771523969/IMG_6091_jmy8tw.mp4",
    poster: "https://res.cloudinary.com/dfudxxzlj/video/upload/so_4,w_400,h_710,c_fill,q_auto,f_jpg/v1771523969/IMG_6091_jmy8tw.jpg",
  },
];
---

<section class={`py-12 md:py-20 relative overflow-hidden ${isLight ? 'bg-transparent' : 'bg-[#0a0a0f]'}`} aria-label="עדויות וידאו מבוגרים" data-section data-vtc-theme={theme}>
  <!-- Background glow -->
  {!isLight && <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-[600px] h-[600px] bg-[#a855f7]/5 rounded-full blur-[150px]"></div>}

  <div class="container relative z-10 px-4 md:px-6">
    <!-- Badge -->
    {badge && (
      <div class="flex justify-center mb-6" data-animate="fade-up">
        <div class={`inline-flex items-center gap-3 px-4 py-2 rounded-full ${isLight ? 'bg-[#f0e6ff] border border-[#d4b8ff]' : 'bg-white/[0.03] backdrop-blur-sm border border-white/[0.08]'}`}>
          <span class="w-1.5 h-1.5 rounded-full bg-[#a855f7] animate-pulse"></span>
          <span class="font-mono text-xs text-[#a855f7] uppercase tracking-[0.15em]">{badge}</span>
        </div>
      </div>
    )}

    <!-- Title -->
    <div class="text-center mb-10" data-animate="fade-up">
      <h2 class={`text-2xl sm:text-3xl md:text-5xl font-bold mb-4 tracking-tight ${isLight ? 'text-[#1a1a2e]' : 'text-white'}`}>
        {useDefaultHighlight ? (
          <><span class="vtc-title-highlight">מספרים</span> עלינו</>
        ) : title}
      </h2>
      <p class={`text-lg max-w-xl mx-auto ${isLight ? 'text-[#6a6a8a]' : 'text-white/50'}`}>{subtitle}</p>
    </div>

    <!-- 3D Carousel -->
    <div class="vtc" aria-label="קרוסלת עדויות וידאו" tabindex="0">
      <div class="vtc-track">
        {testimonials.map((t, i) => (
          <div class="vtc-card" data-vtc={i}>
            <div class="vtc-inner">
              <img
                src={t.poster}
                alt={`${t.name} - ${t.role}`}
                class="vtc-poster"
                loading="lazy"
                draggable="false"
                width="400"
                height="710"
              />
              <!-- Play overlay -->
              <div class="vtc-play">
                <svg class="w-8 h-8 ms-0.5" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                  <path d="M8 5v14l11-7z"/>
                </svg>
              </div>
              <!-- Gradient + info -->
              <div class="vtc-grad"></div>
              <div class="vtc-info">
                <p class="vtc-name">{t.name}</p>
                <p class="vtc-role">{t.role}</p>
              </div>
            </div>
          </div>
        ))}
      </div>

      <!-- Arrows -->
      <button class="vtc-arr vtc-arr-r" aria-label="הקודם">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>
      </button>
      <button class="vtc-arr vtc-arr-l" aria-label="הבא">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg>
      </button>

      <!-- Fingerprint pagination -->
      <div class="vtc-dots">
        {testimonials.map((_, i) => (
          <button class={`vtc-dot${i === 0 ? ' vtc-dot-active' : ''}`} data-dot={i} aria-label={`סרטון ${i + 1}`}>
            <img src="https://res.cloudinary.com/dfudxxzlj/image/upload/q_auto,f_auto,w_40/v1765571815/FOCUS_LOGO-06_2_grkja9.png" alt="" aria-hidden="true" draggable="false" />
          </button>
        ))}
      </div>
    </div>
  </div>

  <!-- Lightbox (all videos pre-rendered with direct src for iOS) -->
  <div class="vtc-lb">
    <div class="vtc-lb-bg"></div>
    <button class="vtc-lb-x" aria-label="סגור">
      <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
    </button>
    {testimonials.map((t, i) => (
      <div class="vtc-lb-item" data-lb={i}>
        <video
          src={t.video}
          poster={t.poster}
          controls
          playsinline
          webkit-playsinline
          preload="none"
          controlslist="nodownload"
          disablepictureinpicture
          class="vtc-lb-vid"
          oncontextmenu="return false;"
        ></video>
        <p class="vtc-lb-name">{t.name}</p>
        <p class="vtc-lb-role">{t.role}</p>
      </div>
    ))}
  </div>
</section>

<script is:inline>
(function() {
  var vtc = document.querySelector('.vtc');
  if (!vtc || vtc.dataset.init) return;
  vtc.dataset.init = '1';

  var cards = vtc.querySelectorAll('.vtc-card');
  var dots = vtc.querySelectorAll('.vtc-dot');
  var total = cards.length;
  var current = 0;
  var lightbox = document.querySelector('.vtc-lb');
  var lbItems = lightbox.querySelectorAll('.vtc-lb-item');
  var activeLb = null;

  // Position all cards based on offset from current center
  function layout() {
    cards.forEach(function(card, i) {
      var offset = i - current;
      // Wrap for infinite loop
      if (offset > total / 2) offset -= total;
      if (offset < -total / 2) offset += total;

      var abs = Math.abs(offset);
      var sign = offset > 0 ? -1 : 1; // Flip for RTL (next=left, prev=right)
      var scale, tx, opa, z;

      if (abs === 0) {
        scale = 1; tx = 0; opa = 1; z = 5;
      } else if (abs === 1) {
        scale = 0.78; tx = sign * 105; opa = 0.6; z = 4;
      } else if (abs === 2) {
        scale = 0.6; tx = sign * 190; opa = 0.3; z = 3;
      } else {
        scale = 0.5; tx = sign * 220; opa = 0; z = 0;
      }

      card.style.transform = 'translateX(' + tx + '%) scale(' + scale + ')';
      card.style.opacity = opa;
      card.style.zIndex = z;
      card.style.pointerEvents = abs <= 1 ? 'auto' : 'none';
      card.classList.toggle('vtc-center', abs === 0);
    });
    // Update fingerprint dots
    dots.forEach(function(dot, i) {
      dot.classList.toggle('vtc-dot-active', i === current);
    });
  }

  function goTo(idx) {
    current = ((idx % total) + total) % total;
    layout();
  }

  // Arrow navigation
  vtc.querySelector('.vtc-arr-l').addEventListener('click', function() { goTo(current + 1); });
  vtc.querySelector('.vtc-arr-r').addEventListener('click', function() { goTo(current - 1); });

  // Dot clicks → navigate
  dots.forEach(function(dot, i) {
    dot.addEventListener('click', function() { goTo(i); });
  });

  // Card clicks: center → lightbox, side → navigate
  cards.forEach(function(card, i) {
    card.addEventListener('click', function() {
      if (i === current) {
        openLightbox(i);
      } else {
        goTo(i);
      }
    });
  });

  // Touch swipe
  var startX = 0;
  var startY = 0;
  var swiping = false;
  vtc.addEventListener('touchstart', function(e) {
    startX = e.touches[0].clientX;
    startY = e.touches[0].clientY;
    swiping = true;
  }, { passive: true });
  vtc.addEventListener('touchend', function(e) {
    if (!swiping) return;
    swiping = false;
    var dx = e.changedTouches[0].clientX - startX;
    var dy = e.changedTouches[0].clientY - startY;
    // Only swipe if horizontal movement > vertical
    if (Math.abs(dx) > 50 && Math.abs(dx) > Math.abs(dy)) {
      goTo(current + (dx > 0 ? -1 : 1));
    }
  });

  // Keyboard
  vtc.addEventListener('keydown', function(e) {
    if (e.key === 'ArrowLeft') { goTo(current + 1); e.preventDefault(); }
    else if (e.key === 'ArrowRight') { goTo(current - 1); e.preventDefault(); }
  });

  // === Lightbox ===
  function openLightbox(idx) {
    activeLb = lbItems[idx];
    if (!activeLb) return;
    activeLb.classList.add('active');
    lightbox.classList.add('active');
    document.body.style.overflow = 'hidden';
  }

  function closeLightbox() {
    if (activeLb) {
      var vid = activeLb.querySelector('video');
      if (vid) vid.pause();
      activeLb.classList.remove('active');
      activeLb = null;
    }
    lightbox.classList.remove('active');
    document.body.style.overflow = '';
  }

  lightbox.querySelector('.vtc-lb-x').addEventListener('click', closeLightbox);
  lightbox.querySelector('.vtc-lb-bg').addEventListener('click', closeLightbox);
  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape' && lightbox.classList.contains('active')) closeLightbox();
  });

  // Init
  layout();
})();
</script>

<style>
  /* === Title highlight gradient === */
  .vtc-title-highlight {
    background: linear-gradient(135deg, #a855f7, #c084fc, #e879f9);
    -webkit-background-clip: text;
    background-clip: text;
    color: transparent;
  }

  /* === 3D Carousel === */
  .vtc {
    position: relative;
    overflow: hidden;
    padding: 0.5rem 0;
  }

  .vtc-track {
    position: relative;
    display: flex;
    align-items: center;
    justify-content: center;
    height: 410px;
  }

  .vtc-card {
    position: absolute;
    width: 220px;
    cursor: pointer;
    transition: transform 0.5s cubic-bezier(0.4, 0, 0.2, 1),
                opacity 0.5s ease;
    will-change: transform, opacity;
  }

  .vtc-inner {
    position: relative;
    aspect-ratio: 9 / 16;
    border-radius: 1rem;
    overflow: hidden;
    background: rgba(255, 255, 255, 0.03);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    border: 1px solid rgba(255, 255, 255, 0.08);
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
    transition: border-color 0.3s, box-shadow 0.3s;
  }

  .vtc-center .vtc-inner {
    border-color: rgba(168, 85, 247, 0.3);
    box-shadow: 0 0 30px rgba(168, 85, 247, 0.15), 0 8px 32px rgba(0, 0, 0, 0.3);
  }

  .vtc-poster {
    position: absolute;
    inset: 0;
    width: 100%;
    height: 100%;
    object-fit: cover;
    user-select: none;
    -webkit-user-drag: none;
  }

  /* Play button - only visible on center card */
  .vtc-play {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 60px;
    height: 60px;
    border-radius: 50%;
    background: rgba(168, 85, 247, 0.85);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    border: 2px solid rgba(255, 255, 255, 0.25);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10;
    opacity: 0;
    transition: opacity 0.3s, transform 0.3s;
    pointer-events: none;
  }

  .vtc-center .vtc-play {
    opacity: 1;
  }

  .vtc-center:hover .vtc-play {
    transform: translate(-50%, -50%) scale(1.1);
    box-shadow: 0 0 30px rgba(168, 85, 247, 0.5);
  }

  .vtc-grad {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    height: 50%;
    background: linear-gradient(to top, rgba(0, 0, 0, 0.8), transparent);
    pointer-events: none;
    z-index: 4;
  }

  .vtc-info {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    padding: 1rem;
    z-index: 5;
    pointer-events: none;
  }

  .vtc-name {
    font-size: 0.9375rem;
    font-weight: 700;
    color: #f5f5fa;
    text-shadow: 0 1px 4px rgba(0, 0, 0, 0.5);
    margin-bottom: 0.125rem;
  }

  .vtc-role {
    font-size: 0.6875rem;
    color: rgba(245, 245, 250, 0.7);
    font-family: 'Rubik', system-ui, sans-serif;
    text-shadow: 0 1px 4px rgba(0, 0, 0, 0.5);
    line-height: 1.3;
  }

  /* Arrows */
  .vtc-arr {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    width: 44px;
    height: 44px;
    border-radius: 50%;
    background: rgba(168, 85, 247, 0.15);
    border: 1px solid rgba(168, 85, 247, 0.3);
    color: #a855f7;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    z-index: 10;
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    transition: all 0.3s;
    padding: 0;
  }

  .vtc-arr:hover {
    background: rgba(168, 85, 247, 0.3);
    transform: translateY(-50%) scale(1.1);
    box-shadow: 0 0 20px rgba(168, 85, 247, 0.3);
  }

  .vtc-arr-r { right: 0.75rem; }
  .vtc-arr-l { left: 0.75rem; }

  /* === Fingerprint Dots === */
  .vtc-dots {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 0.5rem;
    margin-top: 1.25rem;
    padding: 0 1rem;
  }

  .vtc-dot {
    position: relative;
    width: 28px;
    height: 28px;
    padding: 0;
    border: none;
    background: none;
    cursor: pointer;
    opacity: 0.35;
    filter: grayscale(0.5) brightness(1.2);
    transition: opacity 0.4s ease, filter 0.4s ease, transform 0.3s ease;
  }

  .vtc-dot img {
    width: 100%;
    height: 100%;
    object-fit: contain;
    pointer-events: none;
    user-select: none;
    -webkit-user-drag: none;
  }

  .vtc-dot-active {
    opacity: 1;
    filter: grayscale(0) brightness(1) drop-shadow(0 0 6px rgba(168, 85, 247, 0.6));
    transform: scale(1.15);
  }

  .vtc-dot:hover:not(.vtc-dot-active) {
    opacity: 0.6;
    filter: grayscale(0.3) brightness(1.4);
  }

  /* === Lightbox === */
  .vtc-lb {
    position: fixed;
    inset: 0;
    z-index: 9999;
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.3s, visibility 0.3s;
  }

  .vtc-lb.active {
    opacity: 1;
    visibility: visible;
  }

  .vtc-lb-bg {
    position: absolute;
    inset: 0;
    background: rgba(0, 0, 0, 0.92);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
  }

  .vtc-lb-x {
    position: absolute;
    top: 1rem;
    right: 1rem;
    width: 44px;
    height: 44px;
    border-radius: 50%;
    background: rgba(255, 255, 255, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.2);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    z-index: 10;
    padding: 0;
    transition: all 0.3s;
  }

  .vtc-lb-x:hover {
    background: rgba(255, 255, 255, 0.2);
    transform: scale(1.1);
  }

  .vtc-lb-item {
    position: relative;
    z-index: 5;
    text-align: center;
    max-width: 360px;
    width: 90vw;
    display: none;
  }

  .vtc-lb-item.active {
    display: block;
  }

  .vtc-lb-vid {
    width: 100%;
    aspect-ratio: 9 / 16;
    border-radius: 1rem;
    background: #0d0d15;
    object-fit: cover;
  }

  .vtc-lb-name {
    margin-top: 0.75rem;
    font-size: 1.125rem;
    font-weight: 700;
    color: white;
  }

  .vtc-lb-role {
    font-size: 0.8125rem;
    color: rgba(255, 255, 255, 0.6);
    font-family: 'Rubik', system-ui, sans-serif;
    margin-top: 0.25rem;
  }

  /* === Responsive === */
  @media (max-width: 768px) {
    .vtc-track {
      height: calc(60vw * 16 / 9);
    }

    .vtc-card {
      width: 60vw;
      max-width: 240px;
    }

    .vtc-play {
      width: 52px;
      height: 52px;
    }

    .vtc-arr {
      width: 36px;
      height: 36px;
    }

    .vtc-arr-r { right: 0.25rem; }
    .vtc-arr-l { left: 0.25rem; }
  }

  @media (min-width: 769px) and (max-width: 1023px) {
    .vtc-card {
      width: 200px;
    }

    .vtc-track {
      height: 380px;
    }
  }

  /* === Light theme overrides === */
  [data-vtc-theme="light"] .vtc-inner {
    background: rgba(0, 0, 0, 0.05);
    border-color: rgba(0, 0, 0, 0.1);
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12);
  }

  [data-vtc-theme="light"] .vtc-center .vtc-inner {
    border-color: rgba(168, 85, 247, 0.4);
    box-shadow: 0 0 30px rgba(168, 85, 247, 0.12), 0 8px 32px rgba(0, 0, 0, 0.12);
  }

  [data-vtc-theme="light"] .vtc-arr {
    background: rgba(168, 85, 247, 0.1);
    border-color: rgba(168, 85, 247, 0.3);
  }

  [data-vtc-theme="light"] .vtc-arr:hover {
    background: rgba(168, 85, 247, 0.2);
  }

  [data-vtc-theme="light"] .vtc-dot {
    filter: grayscale(1) brightness(0.3);
  }

  [data-vtc-theme="light"] .vtc-dot-active {
    filter: grayscale(0) brightness(0.8) drop-shadow(0 0 6px rgba(168, 85, 247, 0.6));
  }

  [data-vtc-theme="light"] .vtc-dot:hover:not(.vtc-dot-active) {
    filter: grayscale(0.5) brightness(0.5);
  }

  /* Reduced motion */
  @media (prefers-reduced-motion: reduce) {
    .vtc-card {
      transition: none;
    }

    .vtc-inner {
      transition: none;
    }

    .vtc-lb {
      transition: none;
    }
  }
</style>
