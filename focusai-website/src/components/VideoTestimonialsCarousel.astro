---
/**
 * Video Testimonials Carousel
 * 3D carousel with center focus, navigation arrows, and lightbox
 * Styled to match Focus AI cyberpunk aesthetic
 */

const videoTestimonials = [
  {
    name: "זוהר יעקב",
    role: "סטודנט הכשרת Focus AI",
    video: "https://res.cloudinary.com/dfudxxzlj/video/upload/v1770711777/%D7%A4%D7%95%D7%A7%D7%95%D7%A1_%D7%96%D7%95%D7%94%D7%A8_%D7%99%D7%A2%D7%A7%D7%91_s4jds5_1_xhrejb.mp4",
    poster: "https://res.cloudinary.com/dfudxxzlj/video/upload/so_0.1,w_400,h_710,c_fill,q_auto,f_jpg/v1770711777/%D7%A4%D7%95%D7%A7%D7%95%D7%A1_%D7%96%D7%95%D7%94%D7%A8_%D7%99%D7%A2%D7%A7%D7%91_s4jds5_1_xhrejb.jpg",
  },
  {
    name: "חגית",
    role: "מנהלת המרכז לפיתוח קריירה, אוניברסיטת חיפה",
    video: "https://res.cloudinary.com/dfudxxzlj/video/upload/v1770711629/IMG_0753_iah7ft_1_roxnqc.mp4",
    poster: "https://res.cloudinary.com/dfudxxzlj/video/upload/so_0.1,w_400,h_710,c_fill,q_auto,f_jpg/v1770711629/IMG_0753_iah7ft_1_roxnqc.jpg",
  },
  {
    name: "מטר",
    role: "בוגרת הכשרת Focus AI",
    video: "https://res.cloudinary.com/dfudxxzlj/video/upload/v1770711703/%D7%9E%D7%98%D7%A8_%D7%A4%D7%95%D7%A7%D7%95%D7%A1_AI_jg7esj_qtan3r.mp4",
    poster: "https://res.cloudinary.com/dfudxxzlj/video/upload/so_0.1,w_400,h_710,c_fill,q_auto,f_jpg/v1770711703/%D7%9E%D7%98%D7%A8_%D7%A4%D7%95%D7%A7%D7%95%D7%A1_AI_jg7esj_qtan3r.jpg",
  },
  {
    name: "בני",
    role: "בוגר הכשרת Focus AI",
    video: "https://res.cloudinary.com/dfudxxzlj/video/upload/v1770711663/IMG_3467_pg6tos_1_pkb8qv.mp4",
    poster: "https://res.cloudinary.com/dfudxxzlj/video/upload/so_0.1,w_400,h_710,c_fill,q_auto,f_jpg/v1770711663/IMG_3467_pg6tos_1_pkb8qv.jpg",
  },
  {
    name: "שניר",
    role: "בוגר הכשרת Focus AI",
    video: "https://res.cloudinary.com/dfudxxzlj/video/upload/v1770711683/%D7%A9%D7%A0%D7%99%D7%A8_%D7%A4%D7%95%D7%A7%D7%95%D7%A1_AI_mxbzrj_1_cwq90t.mp4",
    poster: "https://res.cloudinary.com/dfudxxzlj/video/upload/so_0.1,w_400,h_710,c_fill,q_auto,f_jpg/v1770711683/%D7%A9%D7%A0%D7%99%D7%A8_%D7%A4%D7%95%D7%A7%D7%95%D7%A1_AI_mxbzrj_1_cwq90t.jpg",
  },
  {
    name: "ארטיום",
    role: "בוגר הכשרת Focus AI",
    video: "https://res.cloudinary.com/dfudxxzlj/video/upload/v1770711686/%D7%90%D7%A8%D7%98%D7%99%D7%95%D7%9D_%D7%A4%D7%95%D7%A7%D7%95%D7%A1_AI_pzkt2y_1_zaaisz.mp4",
    poster: "https://res.cloudinary.com/dfudxxzlj/video/upload/so_0.1,w_400,h_710,c_fill,q_auto,f_jpg/v1770711686/%D7%90%D7%A8%D7%98%D7%99%D7%95%D7%9D_%D7%A4%D7%95%D7%A7%D7%95%D7%A1_AI_pzkt2y_1_zaaisz.jpg",
  },
];
---

<div class="video-carousel-section">
  <div class="carousel-wrapper">
    <div class="carousel-track-area" id="carouselTrack">
      {videoTestimonials.map((testimonial, index) => (
        <div
          class="carousel-slide"
          data-index={index}
          data-video={testimonial.video}
          data-poster={testimonial.poster}
        >
          <div class="aspect-wrapper">
            <div class="skeleton-shimmer"></div>
            <img class="poster-img" alt={testimonial.name} loading="lazy" />
            <video playsinline muted preload="none"></video>
            <div class="play-overlay">
              <div class="play-btn">
                <svg viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
              </div>
            </div>
            <div class="info-box">
              <p class="name">{testimonial.name}</p>
              <p class="role">{testimonial.role}</p>
            </div>
          </div>
        </div>
      ))}
    </div>

    <!-- Navigation Arrows -->
    <button class="carousel-nav-btn nav-right" aria-label="הקודם">
      <svg viewBox="0 0 24 24"><polyline points="9 18 15 12 9 6"/></svg>
    </button>
    <button class="carousel-nav-btn nav-left" aria-label="הבא">
      <svg viewBox="0 0 24 24"><polyline points="15 18 9 12 15 6"/></svg>
    </button>

    <!-- Dots -->
    <div class="carousel-dots" id="carouselDots"></div>
  </div>
</div>

<!-- Lightbox Modal -->
<div id="videoLightbox" class="video-lightbox">
  <!-- Close Button - Top Right -->
  <button class="lightbox-close-btn" aria-label="סגור">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
      <path d="M18 6L6 18M6 6l12 12"/>
    </svg>
  </button>

  <!-- Navigation Arrows -->
  <button class="lightbox-nav lightbox-nav-right" aria-label="הקודם">
    <svg viewBox="0 0 24 24"><polyline points="9 18 15 12 9 6"/></svg>
  </button>
  <button class="lightbox-nav lightbox-nav-left" aria-label="הבא">
    <svg viewBox="0 0 24 24"><polyline points="15 18 9 12 15 6"/></svg>
  </button>

  <div class="lightbox-content">
    <div class="lightbox-video-container">
      <video id="lightboxVideo" controls playsinline></video>
    </div>
    <div class="lightbox-info">
      <p id="lightboxName" class="lightbox-name"></p>
      <p id="lightboxRole" class="lightbox-role"></p>
    </div>
  </div>
</div>

<style>
  .video-carousel-section {
    direction: rtl;
    padding: 20px 0 40px;
    overflow: hidden;
    position: relative;
    user-select: none;
  }

  .carousel-wrapper {
    position: relative;
    max-width: 1100px;
    margin: 0 auto;
    padding: 20px 0 40px;
  }

  .carousel-track-area {
    position: relative;
    height: 520px;
    perspective: 1200px;
  }

  /* Individual Slide */
  .carousel-slide {
    position: absolute;
    top: 50%;
    left: 50%;
    width: 280px;
    border-radius: 24px;
    overflow: hidden;
    background: linear-gradient(135deg, rgba(168, 85, 247, 0.1) 0%, rgba(15, 15, 20, 0.95) 100%);
    cursor: pointer;
    transition: all 0.55s cubic-bezier(0.25, 0.9, 0.35, 1);
    box-shadow: 0 8px 30px rgba(0, 0, 0, 0.3);
    will-change: transform, opacity;
    border: 1px solid rgba(168, 85, 247, 0.2);
  }

  .carousel-slide .aspect-wrapper {
    position: relative;
    width: 100%;
    aspect-ratio: 9 / 16;
    background: #12121a;
  }

  /* Poster image */
  .carousel-slide .poster-img {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    object-fit: cover;
    z-index: 1;
    opacity: 0;
    transition: opacity 0.4s ease;
  }

  .carousel-slide .poster-img.loaded {
    opacity: 1;
  }

  /* Skeleton shimmer */
  .carousel-slide .skeleton-shimmer {
    position: absolute;
    inset: 0;
    z-index: 0;
    background: linear-gradient(110deg, #1a1a24 30%, #252530 50%, #1a1a24 70%);
    background-size: 200% 100%;
    animation: shimmer 1.5s ease-in-out infinite;
  }

  @keyframes shimmer {
    0% { background-position: 200% 0; }
    100% { background-position: -200% 0; }
  }

  .carousel-slide.media-ready .skeleton-shimmer {
    opacity: 0;
    transition: opacity 0.4s ease;
  }

  .carousel-slide video {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    object-fit: cover;
    z-index: 2;
    opacity: 0;
    transition: opacity 0.3s ease;
  }

  .carousel-slide video.video-loaded {
    opacity: 1;
  }

  .carousel-slide .play-overlay {
    position: absolute;
    inset: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    background: linear-gradient(to top, rgba(10, 10, 15, 0.7) 0%, transparent 50%);
    pointer-events: none;
    transition: opacity 0.3s ease;
    z-index: 3;
  }

  .carousel-slide .play-btn {
    width: 60px;
    height: 60px;
    background: rgba(168, 85, 247, 0.9);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 0 30px rgba(168, 85, 247, 0.5);
    transition: all 0.35s ease;
  }

  .carousel-slide:hover .play-btn {
    transform: scale(1.15);
    box-shadow: 0 0 50px rgba(168, 85, 247, 0.7);
  }

  .carousel-slide .play-btn svg {
    width: 26px;
    height: 26px;
    fill: white;
    margin-right: -3px;
  }

  .carousel-slide .info-box {
    position: absolute;
    bottom: 12px;
    right: 12px;
    left: 12px;
    background: rgba(18, 18, 26, 0.85);
    backdrop-filter: blur(16px);
    -webkit-backdrop-filter: blur(16px);
    border-radius: 14px;
    padding: 12px 14px;
    pointer-events: none;
    border: 1px solid rgba(168, 85, 247, 0.2);
    z-index: 4;
  }

  .carousel-slide .info-box .name {
    font-size: 16px;
    font-weight: 700;
    color: #f5f5fa;
    text-align: center;
    margin: 0;
  }

  .carousel-slide .info-box .role {
    font-size: 11px;
    color: #a855f7;
    text-align: center;
    margin: 6px 0 0 0;
    line-height: 1.4;
    font-weight: 500;
  }

  /* Slide Positions */
  .carousel-slide[data-pos="center"] {
    transform: translate(-50%, -50%) scale(1);
    z-index: 5;
    opacity: 1;
    border-color: rgba(168, 85, 247, 0.4);
    box-shadow: 0 0 60px rgba(168, 85, 247, 0.3), 0 20px 50px rgba(0, 0, 0, 0.4);
  }

  .carousel-slide[data-pos="right"] {
    transform: translate(calc(-50% + 310px), -50%) scale(0.82);
    z-index: 3;
    opacity: 0.8;
    filter: brightness(0.85);
  }

  .carousel-slide[data-pos="left"] {
    transform: translate(calc(-50% - 310px), -50%) scale(0.82);
    z-index: 3;
    opacity: 0.8;
    filter: brightness(0.85);
  }

  .carousel-slide[data-pos="far-right"] {
    transform: translate(calc(-50% + 560px), -50%) scale(0.6);
    z-index: 1;
    opacity: 0;
    pointer-events: none;
  }

  .carousel-slide[data-pos="far-left"] {
    transform: translate(calc(-50% - 560px), -50%) scale(0.6);
    z-index: 1;
    opacity: 0;
    pointer-events: none;
  }

  .carousel-slide[data-pos="hidden"] {
    transform: translate(-50%, -50%) scale(0.5);
    z-index: 0;
    opacity: 0;
    pointer-events: none;
  }

  /* Navigation Arrows */
  .carousel-nav-btn {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    width: 52px;
    height: 52px;
    border-radius: 50%;
    border: 1px solid rgba(168, 85, 247, 0.3);
    background: rgba(18, 18, 26, 0.9);
    backdrop-filter: blur(10px);
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10;
    transition: all 0.3s ease;
  }

  .carousel-nav-btn:hover {
    background: #a855f7;
    border-color: #a855f7;
    box-shadow: 0 0 30px rgba(168, 85, 247, 0.5);
    transform: translateY(-50%) scale(1.08);
  }

  .carousel-nav-btn:hover svg {
    stroke: white;
  }

  .carousel-nav-btn svg {
    width: 24px;
    height: 24px;
    stroke: #a855f7;
    stroke-width: 2.5;
    fill: none;
    transition: stroke 0.3s ease;
  }

  .carousel-nav-btn.nav-right {
    right: 20px;
  }

  .carousel-nav-btn.nav-left {
    left: 20px;
  }

  /* Dots - Fingerprint Style */
  .carousel-dots {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 8px;
    margin-top: 20px;
  }

  .carousel-dots :global(.carousel-dot) {
    width: 28px;
    height: 28px;
    border-radius: 50%;
    border: none;
    background-image: url('https://res.cloudinary.com/dfudxxzlj/image/upload/v1765571815/FOCUS_LOGO-06_2_grkja9.png');
    background-size: cover;
    background-position: center;
    cursor: pointer;
    transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
    padding: 0;
    opacity: 0.2;
    filter: grayscale(100%) brightness(0.5);
  }

  .carousel-dots :global(.carousel-dot:hover) {
    opacity: 0.5;
    filter: grayscale(50%) brightness(0.7);
    transform: scale(1.1);
  }

  .carousel-dots :global(.carousel-dot.active) {
    opacity: 1;
    filter: grayscale(0%) brightness(1);
    box-shadow: 0 0 20px rgba(168, 85, 247, 0.7);
    transform: scale(1.2);
  }

  /* Lightbox Modal */
  .video-lightbox {
    display: none;
    position: fixed;
    inset: 0;
    z-index: 999999;
    background: rgba(5, 5, 10, 0.97);
    backdrop-filter: blur(30px);
    align-items: center;
    justify-content: center;
    padding: 20px;
  }

  .video-lightbox.active {
    display: flex;
  }

  /* Close Button - Large & Prominent */
  .lightbox-close-btn {
    position: fixed;
    top: 20px;
    right: 20px;
    width: 56px;
    height: 56px;
    background: rgba(255, 51, 102, 0.9);
    border: none;
    border-radius: 50%;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
    z-index: 100;
    box-shadow: 0 4px 20px rgba(255, 51, 102, 0.4);
  }

  .lightbox-close-btn:hover {
    background: #ff3366;
    transform: scale(1.1);
    box-shadow: 0 6px 30px rgba(255, 51, 102, 0.6);
  }

  .lightbox-close-btn svg {
    width: 28px;
    height: 28px;
    stroke: white;
  }

  /* Lightbox Navigation Arrows */
  .lightbox-nav {
    position: fixed;
    top: 50%;
    transform: translateY(-50%);
    width: 60px;
    height: 60px;
    border-radius: 50%;
    border: 2px solid rgba(168, 85, 247, 0.5);
    background: rgba(18, 18, 26, 0.95);
    backdrop-filter: blur(10px);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 100;
    transition: all 0.3s ease;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
  }

  .lightbox-nav:hover {
    background: #a855f7;
    border-color: #a855f7;
    box-shadow: 0 0 40px rgba(168, 85, 247, 0.6);
    transform: translateY(-50%) scale(1.1);
  }

  .lightbox-nav svg {
    width: 28px;
    height: 28px;
    stroke: #a855f7;
    stroke-width: 2.5;
    fill: none;
    transition: stroke 0.3s ease;
  }

  .lightbox-nav:hover svg {
    stroke: white;
  }

  .lightbox-nav-right {
    right: 20px;
  }

  .lightbox-nav-left {
    left: 20px;
  }

  /* Lightbox Content */
  .lightbox-content {
    max-width: 400px;
    width: 100%;
    display: flex;
    flex-direction: column;
    align-items: center;
  }

  .lightbox-video-container {
    width: 100%;
    aspect-ratio: 9/16;
    border-radius: 24px;
    overflow: hidden;
    background: #000;
    box-shadow: 0 0 100px rgba(168, 85, 247, 0.4), 0 30px 80px rgba(0, 0, 0, 0.6);
    border: 2px solid rgba(168, 85, 247, 0.4);
  }

  .lightbox-video-container video {
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: block;
  }

  .lightbox-info {
    text-align: center;
    margin-top: 24px;
  }

  .lightbox-name {
    font-size: 24px;
    font-weight: 700;
    color: #f5f5fa;
    margin: 0;
  }

  .lightbox-role {
    font-size: 15px;
    color: #a855f7;
    margin: 10px 0 0 0;
  }

  /* Mobile Lightbox */
  @media (max-width: 640px) {
    .lightbox-close-btn {
      top: 12px;
      right: 12px;
      width: 48px;
      height: 48px;
    }

    .lightbox-close-btn svg {
      width: 24px;
      height: 24px;
    }

    .lightbox-nav {
      width: 48px;
      height: 48px;
    }

    .lightbox-nav svg {
      width: 22px;
      height: 22px;
    }

    .lightbox-nav-right {
      right: 10px;
    }

    .lightbox-nav-left {
      left: 10px;
    }

    .lightbox-content {
      max-width: 85vw;
    }

    .lightbox-video-container {
      border-radius: 18px;
    }

    .lightbox-name {
      font-size: 20px;
    }

    .lightbox-role {
      font-size: 13px;
    }
  }

  /* Responsive */
  @media (max-width: 900px) {
    .carousel-track-area {
      height: 480px;
    }
    .carousel-slide {
      width: 250px;
    }
    .carousel-slide[data-pos="right"] {
      transform: translate(calc(-50% + 260px), -50%) scale(0.78);
    }
    .carousel-slide[data-pos="left"] {
      transform: translate(calc(-50% - 260px), -50%) scale(0.78);
    }
  }

  @media (max-width: 640px) {
    .video-carousel-section {
      padding: 10px 0 20px;
    }
    .carousel-wrapper {
      padding: 10px 0 30px;
    }
    .carousel-track-area {
      height: 420px;
    }
    .carousel-slide {
      width: 210px;
    }
    .carousel-slide[data-pos="center"] {
      transform: translate(-50%, -50%) scale(1);
    }
    .carousel-slide[data-pos="right"] {
      transform: translate(calc(-50% + 190px), -50%) scale(0.72);
      opacity: 0.6;
    }
    .carousel-slide[data-pos="left"] {
      transform: translate(calc(-50% - 190px), -50%) scale(0.72);
      opacity: 0.6;
    }
    .carousel-nav-btn {
      width: 44px;
      height: 44px;
    }
    .carousel-nav-btn svg {
      width: 20px;
      height: 20px;
    }
    .carousel-nav-btn.nav-right {
      right: 8px;
    }
    .carousel-nav-btn.nav-left {
      left: 8px;
    }
    .carousel-slide .info-box {
      padding: 8px 10px;
      bottom: 8px;
      right: 8px;
      left: 8px;
      border-radius: 10px;
    }
    .carousel-slide .info-box .name {
      font-size: 14px;
    }
    .carousel-slide .info-box .role {
      font-size: 9px;
      margin-top: 3px;
    }
    .carousel-slide .play-btn {
      width: 48px;
      height: 48px;
    }
    .carousel-slide .play-btn svg {
      width: 22px;
      height: 22px;
    }
  }

  @media (max-width: 400px) {
    .carousel-track-area {
      height: 380px;
    }
    .carousel-slide {
      width: 185px;
    }
    .carousel-slide[data-pos="right"] {
      transform: translate(calc(-50% + 160px), -50%) scale(0.68);
    }
    .carousel-slide[data-pos="left"] {
      transform: translate(calc(-50% - 160px), -50%) scale(0.68);
    }
  }
</style>

<script>
(function() {
  let currentIndex = 0;
  let lightboxIndex = 0;
  const slides = document.querySelectorAll('.carousel-slide');
  const totalSlides = slides.length;
  let isAnimating = false;
  let touchStartX = 0;
  let carouselInView = false;
  let lightboxOpen = false;
  const postersLoaded: Record<string, boolean> = {};
  const videosLoaded: Record<string, boolean> = {};

  const sectionEl = document.querySelector('.video-carousel-section');
  if (!sectionEl) return;

  const sectionObserver = new IntersectionObserver((entries) => {
    entries.forEach((entry) => {
      if (entry.isIntersecting && !carouselInView) {
        carouselInView = true;
        loadVisiblePosters();
        setTimeout(() => preloadNearbyVideos(), 800);
        sectionObserver.unobserve(sectionEl);
      }
    });
  }, { rootMargin: '200px 0px' });

  sectionObserver.observe(sectionEl);

  function loadVisiblePosters() {
    slides.forEach((slide) => {
      const pos = slide.getAttribute('data-pos');
      if (pos === 'center' || pos === 'left' || pos === 'right') {
        loadPoster(slide as HTMLElement);
      }
    });
    setTimeout(() => {
      slides.forEach((slide) => loadPoster(slide as HTMLElement));
    }, 1500);
  }

  function loadPoster(slide: HTMLElement) {
    const idx = slide.getAttribute('data-index');
    if (!idx || postersLoaded[idx]) return;
    const posterUrl = slide.getAttribute('data-poster');
    if (!posterUrl) return;
    const img = slide.querySelector('.poster-img') as HTMLImageElement;
    if (!img) return;
    img.onload = () => {
      img.classList.add('loaded');
      slide.classList.add('media-ready');
    };
    img.onerror = () => {
      slide.classList.add('media-ready');
    };
    img.src = posterUrl;
    postersLoaded[idx] = true;
  }

  function preloadNearbyVideos() {
    const nearbyIndices = getNeighborIndices(currentIndex, 1);
    nearbyIndices.forEach((idx) => loadVideoSrc(idx));
  }

  function loadVideoSrc(idx: number) {
    if (videosLoaded[idx]) return;
    const slide = document.querySelector(`.carousel-slide[data-index="${idx}"]`) as HTMLElement;
    if (!slide) return;
    const videoUrl = slide.getAttribute('data-video');
    if (!videoUrl) return;
    const video = slide.querySelector('video') as HTMLVideoElement;
    if (!video || (video.src && video.src !== '')) return;
    video.src = videoUrl + '#t=0.1';
    video.preload = 'metadata';
    video.onloadeddata = () => {
      video.classList.add('video-loaded');
    };
    videosLoaded[idx] = true;
  }

  function getNeighborIndices(center: number, range: number): number[] {
    const indices = [center];
    for (let i = 1; i <= range; i++) {
      indices.push((center + i) % totalSlides);
      indices.push((center - i + totalSlides) % totalSlides);
    }
    return indices;
  }

  // Build dots
  const dotsContainer = document.getElementById('carouselDots');
  if (dotsContainer) {
    for (let i = 0; i < totalSlides; i++) {
      const dot = document.createElement('button');
      dot.className = 'carousel-dot' + (i === 0 ? ' active' : '');
      dot.setAttribute('data-dot', String(i));
      dot.onclick = () => goToSlide(i);
      dotsContainer.appendChild(dot);
    }
  }

  function getPosition(offset: number): string {
    if (offset === 0) return 'center';
    if (offset === 1) return 'left';
    if (offset === -1) return 'right';
    if (offset === 2) return 'far-left';
    if (offset === -2) return 'far-right';
    return 'hidden';
  }

  function updateSlides() {
    slides.forEach((slide) => {
      const idx = parseInt(slide.getAttribute('data-index') || '0');
      let diff = idx - currentIndex;
      if (diff > totalSlides / 2) diff -= totalSlides;
      if (diff < -totalSlides / 2) diff += totalSlides;
      slide.setAttribute('data-pos', getPosition(diff));
    });

    const dots = document.querySelectorAll('.carousel-dot');
    dots.forEach((dot, i) => {
      dot.classList.toggle('active', i === currentIndex);
    });

    if (carouselInView) {
      slides.forEach((slide) => {
        const pos = slide.getAttribute('data-pos');
        if (pos === 'center' || pos === 'left' || pos === 'right') {
          loadPoster(slide as HTMLElement);
        }
      });
      setTimeout(() => preloadNearbyVideos(), 300);
    }
  }

  function goToSlide(idx: number) {
    if (isAnimating || idx === currentIndex) return;
    isAnimating = true;
    currentIndex = idx;
    updateSlides();
    setTimeout(() => { isAnimating = false; }, 550);
  }

  function carouselNav(dir: number) {
    if (isAnimating) return;
    isAnimating = true;
    currentIndex = (currentIndex + dir + totalSlides) % totalSlides;
    updateSlides();
    setTimeout(() => { isAnimating = false; }, 550);
  }

  function handleSlideClick(slide: HTMLElement) {
    const pos = slide.getAttribute('data-pos');
    if (pos === 'center') {
      const idx = parseInt(slide.getAttribute('data-index') || '0');
      openLightbox(idx);
    } else if (pos === 'right') {
      carouselNav(-1);
    } else if (pos === 'left') {
      carouselNav(1);
    }
  }

  function getVideoData(idx: number) {
    const slide = document.querySelector(`.carousel-slide[data-index="${idx}"]`) as HTMLElement;
    if (!slide) return null;
    return {
      video: slide.getAttribute('data-video') || '',
      name: slide.querySelector('.name')?.textContent || '',
      role: slide.querySelector('.role')?.textContent || ''
    };
  }

  function openLightbox(idx: number) {
    const lightbox = document.getElementById('videoLightbox');
    const video = document.getElementById('lightboxVideo') as HTMLVideoElement;
    if (!lightbox || !video) return;

    lightboxIndex = idx;
    lightboxOpen = true;
    updateLightboxContent();

    lightbox.classList.add('active');
    document.body.style.overflow = 'hidden';
    setTimeout(() => video.play(), 150);
  }

  function updateLightboxContent() {
    const video = document.getElementById('lightboxVideo') as HTMLVideoElement;
    const nameEl = document.getElementById('lightboxName');
    const roleEl = document.getElementById('lightboxRole');

    const data = getVideoData(lightboxIndex);
    if (!data || !video) return;

    video.pause();
    video.src = data.video;
    if (nameEl) nameEl.textContent = data.name;
    if (roleEl) roleEl.textContent = data.role;
    setTimeout(() => video.play(), 100);
  }

  function lightboxNav(dir: number) {
    if (!lightboxOpen) return;
    lightboxIndex = (lightboxIndex + dir + totalSlides) % totalSlides;
    updateLightboxContent();
  }

  function closeLightbox() {
    const lightbox = document.getElementById('videoLightbox');
    const video = document.getElementById('lightboxVideo') as HTMLVideoElement;
    if (!lightbox || !video) return;
    video.pause();
    video.src = '';
    lightbox.classList.remove('active');
    document.body.style.overflow = '';
    lightboxOpen = false;
  }

  // Event listeners
  slides.forEach((slide) => {
    slide.addEventListener('click', () => handleSlideClick(slide as HTMLElement));
  });

  document.querySelector('.nav-right')?.addEventListener('click', () => carouselNav(-1));
  document.querySelector('.nav-left')?.addEventListener('click', () => carouselNav(1));

  const lightbox = document.getElementById('videoLightbox');
  lightbox?.addEventListener('click', (e) => {
    if (e.target === lightbox) closeLightbox();
  });
  lightbox?.querySelector('.lightbox-close-btn')?.addEventListener('click', closeLightbox);
  lightbox?.querySelector('.lightbox-content')?.addEventListener('click', (e) => e.stopPropagation());

  // Lightbox navigation buttons
  lightbox?.querySelector('.lightbox-nav-right')?.addEventListener('click', (e) => {
    e.stopPropagation();
    lightboxNav(-1);
  });
  lightbox?.querySelector('.lightbox-nav-left')?.addEventListener('click', (e) => {
    e.stopPropagation();
    lightboxNav(1);
  });

  // Touch support
  const trackArea = document.getElementById('carouselTrack');
  trackArea?.addEventListener('touchstart', (e) => {
    touchStartX = e.changedTouches[0].screenX;
  }, { passive: true });

  trackArea?.addEventListener('touchend', (e) => {
    const touchEndX = e.changedTouches[0].screenX;
    const diff = touchStartX - touchEndX;
    if (Math.abs(diff) > 50) {
      carouselNav(diff > 0 ? 1 : -1);
    }
  }, { passive: true });

  // Keyboard
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
      if (lightboxOpen) closeLightbox();
    }
    if (e.key === 'ArrowRight') {
      if (lightboxOpen) {
        lightboxNav(-1);
      } else {
        carouselNav(-1);
      }
    }
    if (e.key === 'ArrowLeft') {
      if (lightboxOpen) {
        lightboxNav(1);
      } else {
        carouselNav(1);
      }
    }
  });

  // Init
  updateSlides();
})();
</script>
