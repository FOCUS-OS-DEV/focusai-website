---
/**
 * Analytics Component
 * Includes Google Tag Manager, Microsoft Clarity, and respects cookie consent
 *
 * To set up:
 * 1. Get GTM ID from https://tagmanager.google.com (format: GTM-XXXXXXX)
 * 2. Get Clarity ID from https://clarity.microsoft.com (format: abc123xyz)
 * 3. Add IDs to src/data/config.ts under analytics section
 */
import { siteConfig } from '../data/config';

const { gtmId, clarityId, ga4Id, metaPixelId } = siteConfig.analytics;
---

{/* Google Tag Manager - Head Script */}
{gtmId && (
  <script is:inline define:vars={{ gtmId }}>
    // Only load if user has consented to analytics cookies
    (function() {
      function hasAnalyticsConsent() {
        try {
          var raw = localStorage.getItem('focus_ai_cookie_consent');
          if (!raw) return false;
          var consent = JSON.parse(raw);
          return consent && consent.analytics === true;
        } catch(e) { return false; }
      }

      function loadGTM() {
        if (window.__gtm_loaded) return;
        window.__gtm_loaded = true;
        (function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
        new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
        j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
        'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
        })(window,document,'script','dataLayer',gtmId);
      }

      if (hasAnalyticsConsent()) loadGTM();
      document.addEventListener('analytics-consent-granted', loadGTM);
    })();
  </script>
)}

{/* Microsoft Clarity - Head Script */}
{clarityId && (
  <script is:inline define:vars={{ clarityId }}>
    // Only load if user has consented to analytics cookies
    (function() {
      function hasAnalyticsConsent() {
        try {
          var raw = localStorage.getItem('focus_ai_cookie_consent');
          if (!raw) return false;
          var consent = JSON.parse(raw);
          return consent && consent.analytics === true;
        } catch(e) { return false; }
      }

      function loadClarity() {
        if (window.__clarity_loaded) return;
        window.__clarity_loaded = true;
        (function(c,l,a,r,i,t,y){
          c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
          t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;
          y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
        })(window,document,"clarity","script",clarityId);
      }

      if (hasAnalyticsConsent()) loadClarity();
      document.addEventListener('analytics-consent-granted', loadClarity);
    })();
  </script>
)}

{/* Meta Pixel (Facebook) - Marketing */}
{metaPixelId && (
  <script is:inline define:vars={{ metaPixelId }}>
    (function() {
      function hasMarketingConsent() {
        try {
          var raw = localStorage.getItem('focus_ai_cookie_consent');
          if (!raw) return false;
          var consent = JSON.parse(raw);
          return consent && consent.marketing === true;
        } catch(e) { return false; }
      }

      function loadMetaPixel() {
        if (window.__meta_pixel_loaded) return;
        window.__meta_pixel_loaded = true;
        !function(f,b,e,v,n,t,s){if(f.fbq)return;n=f.fbq=function(){n.callMethod?
        n.callMethod.apply(n,arguments):n.queue.push(arguments)};if(!f._fbq)f._fbq=n;
        n.push=n;n.loaded=!0;n.version='2.0';n.queue=[];t=b.createElement(e);t.async=!0;
        t.src=v;s=b.getElementsByTagName(e)[0];s.parentNode.insertBefore(t,s)}(window,
        document,'script','https://connect.facebook.net/en_US/fbevents.js');
        fbq('init', metaPixelId);
        fbq('track', 'PageView');
        document.dispatchEvent(new CustomEvent('meta-pixel-ready'));
      }

      if (hasMarketingConsent()) loadMetaPixel();
      document.addEventListener('marketing-consent-granted', loadMetaPixel);
    })();
  </script>
)}

{/* Google Analytics 4 Direct (if not using GTM) */}
{ga4Id && !gtmId && (
  <>
    <script is:inline define:vars={{ ga4Id }}>
      // Only load if user has consented to analytics cookies
      (function() {
        function hasAnalyticsConsent() {
          try {
            var raw = localStorage.getItem('focus_ai_cookie_consent');
            if (!raw) return false;
            var consent = JSON.parse(raw);
            return consent && consent.analytics === true;
          } catch(e) { return false; }
        }

        function loadGA4() {
          if (window.__ga4_loaded) return;
          window.__ga4_loaded = true;
          var script = document.createElement('script');
          script.async = true;
          script.src = 'https://www.googletagmanager.com/gtag/js?id=' + ga4Id;
          document.head.appendChild(script);

          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());
          gtag('config', ga4Id);
        }

        if (hasAnalyticsConsent()) loadGA4();
        document.addEventListener('analytics-consent-granted', loadGA4);
      })();
    </script>
  </>
)}
